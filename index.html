<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ocarina Fingering Trainer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* --- デザインシステム --- */
  :root {
    --primary-color: #4a80e2; /* 上品な青 */
    --primary-light: #eaf2ff; /* 明るい青 */
    --background-color: #f7f9fc; /* 背景色 */
    --surface-color: #ffffff; /* カードなどの背景色 */
    --text-color: #333333; /* 基本の文字色 */
    --text-light-color: #777777; /* 淡い文字色 */
    --border-color: #e0e6f0; /* 境界線 */
    --radius: 12px; /* 角丸の半径 */
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* 影 */
    --shadow-light: 0 2px 6px rgba(0, 0, 0, 0.05);
  }

  /* --- 基本設定 --- */
  * { box-sizing: border-box; }
  body {
    font-family: "Noto Sans JP", system-ui, sans-serif;
    margin: 0;
    background: var(--background-color);
    color: var(--text-color);
    text-rendering: optimizeLegibility;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 1rem 2rem;
  }

  /* --- ヘッダー --- */
  header {
    background: var(--surface-color);
    border-bottom: 1px solid var(--border-color);
    padding: 1.5rem 0;
    margin-bottom: 2rem;
  }
  header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    text-align: center;
    letter-spacing: 0.05em;
  }

  main { flex: 1; }

  /* --- タブ --- */
  .tabs {
    display: flex;
    gap: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 1.5rem;
  }
  .tabs button {
    border: none;
    background: none;
    padding: 0.8rem 0.2rem;
    cursor: pointer;
    font-weight: 500;
    font-size: 1rem;
    color: var(--text-light-color);
    position: relative;
    transition: color 0.3s ease;
  }
  .tabs button::after {
    content: '';
    position: absolute;
    bottom: -1px;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary-color);
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }
  .tabs button.active { color: var(--text-color); font-weight: 700; }
  .tabs button.active::after { transform: scaleX(1); }

  /* --- コンテンツセクション --- */
  section { display: none; }
  section.active { display: block; }
  section > p {
    color: var(--text-light-color);
    text-align: center;
    margin-bottom: 1.5rem; /* マージン調整 */
  }

  /* --- 【変更点】鍵盤用 運指表示エリア --- */
  #key-fingering-display {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 180px;
    margin: 0 auto 1.5rem auto;
    background: var(--surface-color);
    border-radius: var(--radius);
    box-shadow: var(--shadow-light);
    padding: 1rem;
    max-width: 250px;
  }
  #key-fingering-display .card {
    box-shadow: none;
    padding: 0;
  }
  #key-fingering-display span {
    color: var(--text-light-color);
  }

  /* --- ピアノ + 五線譜 --- */
  .piano-staff {
    display: flex;
    gap: 2rem;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    background: var(--surface-color);
    padding: 2rem;
    border-radius: var(--radius);
    box-shadow: var(--shadow-light);
  }
  .piano { position: relative; user-select: none; width: max-content; height: 160px; }
  .white-key, .black-key {
    display: inline-block;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
  }
  .white-key {
    width: 36px;
    height: 160px;
    background: #fff;
    border: 1px solid #e0e0e0;
    position: relative;
    float: left;
  }
  .white-key.active {
    background: var(--primary-light);
    border-color: var(--primary-color);
  }
  .black-key {
    position: absolute;
    width: 26px;
    height: 100px;
    background: #333;
    z-index: 1;
    border: 3px solid var(--surface-color);
  }
  .black-key.active { background: var(--primary-color); }
  
  .key-label {
    position: absolute;
    bottom: 8px;
    left: 0;
    width: 100%;
    text-align: center;
    font-size: 14px;
    color: var(--text-light-color);
    pointer-events: none; /* クリックの邪魔にならないように */
  }

  .staff-img {
    width: 240px;
    height: 160px;
    object-fit: contain;
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
  }

  /* --- 運指表示ボード (音名入力用) --- */
  .board {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 1.5rem;
    justify-items: center;
    margin-top: 2rem;
  }
  .card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--surface-color);
    border-radius: var(--radius);
    box-shadow: var(--shadow-light);
    width: 100%;
    min-height: 150px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card.rest-card { background: transparent; box-shadow: none; cursor: default !important; }
  
  .card:not(.rest-card):hover {
    transform: translateY(-4px);
    box-shadow: 0 0 0 2px var(--primary-color), var(--shadow);
  }

  .card.active {
    box-shadow: 0 0 0 3px var(--primary-color);
    transform: translateY(-2px);
  }
  .card.rest-card.active { background: var(--primary-light); box-shadow: none; }
  .card img { width: 100px; height: auto; }
  .note-label { font-weight: 500; font-size: 1rem; }

  /* --- 入力フォーム --- */
  .seq-wrapper { max-width: 600px; margin: 0 auto; text-align: center; }
  #seq-input {
    width: 100%;
    padding: 0.8rem 1rem;
    border: 1px solid var(--border-color);
    border-radius: var(--radius);
    font-size: 1rem;
    background: var(--surface-color);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  #seq-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-light); }
  .btn {
    margin-top: 1rem;
    padding: 0.8rem 2rem;
    border: none;
    border-radius: var(--radius);
    background: var(--primary-color);
    color: #fff;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.2s;
  }
  .btn:hover { background-color: #3a70c2; transform: translateY(-2px); }

  /* --- 移調コントロール --- */
  .transpose-controls {
    display: none;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    background: var(--primary-light);
    padding: 1rem;
    border-radius: var(--radius);
    flex-wrap: wrap;
  }
  .transpose-controls .btn { margin-top: 0; }
  .transpose-controls span {
    font-size: 1.1rem;
    font-weight: 700;
    width: 100px;
    display: inline-block;
    text-align: center;
  }

  /* --- レスポンシブ --- */
  @media(max-width: 768px) {
    .container { padding: 1rem; }
    header h1 { font-size: 1.3rem; }
    .piano-staff { padding: 1.5rem; }
    .board { grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .card img { width: 80px; }
  }
  @media(max-width: 480px) { .board { grid-template-columns: repeat(2, 1fr); } .tabs { gap: 1rem; } }
</style>
</head>
<body>
<header>
  <div class="container"><h1>Ocarina Fingering Trainer</h1></div>
</header>
<div class="container">
  <main>
    <div class="tabs">
      <button id="tab-key" class="active">鍵盤で探す</button>
      <button id="tab-seq">音名で入力</button>
    </div>

    <section id="page-key" class="active">
      <p>ピアノの鍵盤をクリックすると、その下に運指が表示されます。</p>
      <div id="key-fingering-display">
        <span>鍵盤を選択してください</span>
      </div>
      <div class="piano-staff">
        <div id="piano" class="piano"></div>
        <img id="staff-img" class="staff-img" src="./img/staff_blank.png" alt="五線譜">
      </div>
    </section>

    <section id="page-seq">
      <p>「ドレミ」や「C D E」のように音名を入力して、運指を一覧で表示します。スペースで休符も入力できます。</p>
      <div class="seq-wrapper">
        <input id="seq-input" placeholder="例: ド レ ミ (スペースで休符)" />
        <button id="seq-btn" class="btn">運指を表示</button>
      </div>
      <div id="transpose-controls" class="transpose-controls">
        <button id="transpose-down" class="btn">- Key</button>
        <span id="transpose-level">Key: 0</span>
        <button id="transpose-up" class="btn">+ Key</button>
      </div>
      <div id="board-seq" class="board"></div>
    </section>
  </main>
</div>

<script>
/* ========= Web Audio ========= */
let audioContext;
try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { console.error('Web Audio API unsupported'); }

/* ========= Alto C オカリナ音域 ========= */
const OCARINA_RANGE = [
  'A','A#','B','C','C#','D','D#','E','F','F#','G','G#',
  'A2','A#2','B2','C2','C#2','D2','D#2','E2','F2'
];

/* ========= 周波数 (実音) ========= */
const NOTE_FREQUENCIES = {
  'A': 440.00, 'A#': 466.16, 'Bb': 466.16, 'B': 493.88,
  'C': 523.25, 'C#': 554.37, 'Db': 554.37, 'D': 587.33, 'D#': 622.25, 'Eb': 622.25,
  'E': 659.25, 'F': 698.46, 'F#': 739.99, 'Gb': 739.99, 'G': 783.99, 'G#': 830.61, 'Ab': 830.61,
  'A2': 880.00, 'A#2': 932.33, 'Bb2': 932.33, 'B2': 987.77,
  'C2': 1046.50, 'C#2': 1108.73, 'Db2': 1108.73, 'D2': 1174.66, 'D#2': 1244.51, 'Eb2': 1244.51,
  'E2': 1318.51, 'F2': 1396.91
};

/* ========= 名前 → インデックス ========= */
const NOTE_TO_INDEX = Object.fromEntries(OCARINA_RANGE.map((n,i) => [n,i]));

/* ========= 入力トークン → ノート ========= */
const INPUT_TO_NOTE = {
  'ら':'A','ら#':'A#','ら♯':'A#','し':'B', 'ど':'C','ど#':'C#','ど♯':'C#', 'れ':'D','れ#':'D#','れ♯':'D#', 'み':'E', 'ふぁ':'F','ふぁ#':'F#','ふぁ♯':'F#', 'そ':'G','そ#':'G#','そ♯':'G#',
  'ら2':'A2','ら#2':'A#2','ら♯2':'A#2','し2':'B2', 'ど2':'C2','ど#2':'C#2','ど♯2':'C#2', 'れ2':'D2','れ#2':'D#2','れ♯2':'D#2', 'み2':'E2','ふぁ2':'F2',
  'ラ':'A','ラ#':'A#','ラ♯':'A#','シ':'B', 'ド':'C','ド#':'C#','ド♯':'C#', 'レ':'D','レ#':'D#','レ♯':'D#', 'ミ':'E', 'ファ':'F','ファ#':'F#','ファ♯':'F#', 'ソ':'G','ソ#':'G#','ソ♯':'G#',
  'ラ2':'A2','ラ#2':'A#2','ラ♯2':'A#2','シ2':'B2', 'ド2':'C2','ド#2':'C#2','ド♯2':'C#2', 'レ2':'D2','レ#2':'D#2','レ♯2':'D#2', 'ミ2':'E2','ファ2':'F2',
  'A':'A','A#':'A#','BB':'A#','B':'B', 'C':'C','C#':'C#','DB':'C#','D':'D','D#':'D#','EB':'D#', 'E':'E','F':'F','F#':'F#','GB':'F#','G':'G','G#':'G#','AB':'G#',
  'A2':'A2','A#2':'A#2','BB2':'A#2','B2':'B2', 'C2':'C2','C#2':'C#2','DB2':'C#2','D2':'D2','D#2':'D#2','EB2':'D#2', 'E2':'E2','F2':'F2'
};

/* --- 運指画像のファイル名定義 --- */
const IMG_PATH = './img/';
const FINGERING_IMG = {
  'A':'fingering_A.png', 'A#':'fingering_As.png', 'B':'fingering_B.png', 'C':'fingering_C.png', 'C#':'fingering_Cs.png', 'D':'fingering_D.png', 'D#':'fingering_Ds.png', 'E':'fingering_E.png', 'F':'fingering_F.png', 'F#':'fingering_Fs.png', 'G':'fingering_G.png', 'G#':'fingering_Gs.png',
  'A2':'fingering_A2.png', 'A#2':'fingering_As2.png', 'B2':'fingering_B2.png', 'C2':'fingering_C2.png', 'C#2':'fingering_Cs2.png', 'D2':'fingering_D2.png', 'D#2':'fingering_Ds2.png', 'E2':'fingering_E2.png', 'F2':'fingering_F2.png'
};
const STAFF_IMG = {
  'A':'staff_A.png','A#':'staff_As.png','Bb':'staff_Bb.png','B':'staff_B.png', 'C':'staff_C.png','C#':'staff_Cs.png','Db':'staff_Db.png','D':'staff_D.png','D#':'staff_Ds.png','Eb':'staff_Eb.png', 'E':'staff_E.png','F':'staff_F.png','F#':'staff_Fs.png','Gb':'staff_Gb.png','G':'staff_G.png','G#':'staff_Gs.png','Ab':'staff_Ab.png',
  'A2':'staff_A2.png','A#2':'staff_As2.png','Bb2':'staff_Bb2.png','B2':'staff_B2.png','C2':'staff_C2.png','C#2':'staff_Cs2.png','Db2':'staff_Db2.png','D2':'staff_D2.png','D#2':'staff_Ds2.png','Eb2':'staff_Eb2.png','E2':'staff_E2.png','F2':'staff_F2.png'
};
const STAFF_BLANK = 'staff_blank.png';
const SHARP_TO_FLAT = { 'A#':'Bb','C#':'Db','D#':'Eb','F#':'Gb','G#':'Ab','A#2':'Bb2','C#2':'Db2','D#2':'Eb2' };

/* ========= DOM ========= */
const pianoRoot = document.getElementById('piano');
const staffImg  = document.getElementById('staff-img');
const keyFingeringDisplay = document.getElementById('key-fingering-display'); // 【変更点】
const tabs = {
  key: { btn: document.getElementById('tab-key'), page: document.getElementById('page-key') },
  seq: { btn: document.getElementById('tab-seq'), page: document.getElementById('page-seq') }
};

/* ========= 状態 ========= */
let currentNoteIndex = null;
let currentSequenceIndex = null;

/* ========= Audio ========= */
function playNote(freq, dur = 0.45) {
  if (!audioContext || !freq) return;
  if (audioContext.state === 'suspended') audioContext.resume();
  const osc = audioContext.createOscillator();
  const gain = audioContext.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freq, audioContext.currentTime);
  gain.gain.setValueAtTime(0.5, audioContext.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + dur);
  osc.connect(gain); gain.connect(audioContext.destination);
  osc.start(); osc.stop(audioContext.currentTime + dur);
}

/* ========= UI Helper ========= */
function setStaff(key) {
  staffImg.src = key && STAFF_IMG[key] ? IMG_PATH + STAFF_IMG[key] : IMG_PATH + STAFF_BLANK;
}
function highlightKeys(note) {
  document.querySelectorAll('.piano .white-key, .piano .black-key').forEach(k => k.classList.toggle('active', k.dataset.note === note));
}

// createCardは両方のタブで共通に使う
function createCard(note, label) {
  const wrap = document.createElement('div');
  wrap.className = 'card';
  const lbl = document.createElement('div');
  lbl.className = 'note-label';
  lbl.textContent = label;
  if (note === 'REST') {
    wrap.classList.add('rest-card');
    lbl.style.color = 'var(--text-light-color)';
    wrap.appendChild(lbl);
    return wrap;
  }
  const img = document.createElement('img');
  img.onerror = () => { img.style.display = 'none'; lbl.style.color = '#888'; lbl.textContent += ' (画像なし)'; };
  if (note && FINGERING_IMG[note]) { img.src = IMG_PATH + FINGERING_IMG[note]; img.alt = `${note} fingering`; } else { img.style.display = 'none'; }
  wrap.appendChild(lbl); wrap.appendChild(img);
  return wrap;
}

// 【変更点】単一ノートの表示処理を固定エリア表示に
function renderSingle(note) {
  if (!(note in NOTE_FREQUENCIES)) return;
  const staffKey = SHARP_TO_FLAT[note] || note;
  highlightKeys(note);
  setStaff(staffKey);
  
  // 固定エリアに運指カードを表示
  keyFingeringDisplay.innerHTML = ''; // 中身をクリア
  const card = createCard(note, staffKey.replace(/b/, '♭').replace(/#/, '♯'));
  keyFingeringDisplay.appendChild(card);
  
  playNote(NOTE_FREQUENCIES[note]);
  currentNoteIndex = NOTE_TO_INDEX[note];
}

function moveNote(step) {
  if (currentNoteIndex === null) {
      renderSingle(OCARINA_RANGE[0]);
      return;
  }
  const newIdx = currentNoteIndex + step;
  if (newIdx < 0 || newIdx >= OCARINA_RANGE.length) return;
  renderSingle(OCARINA_RANGE[newIdx]);
}

/* ========= Piano Build ========= */
(function buildPiano() {
  const whiteKeysData = OCARINA_RANGE.filter(n => !n.includes('#'));
  const blackKeysData = OCARINA_RANGE.filter(n => n.includes('#'));
  const whiteKeyElements = {};
  
  const noteToDoremi = { 'C': 'ド', 'D': 'レ', 'E': 'ミ', 'F': 'ファ', 'G': 'ソ', 'A': 'ラ', 'B': 'シ' };

  whiteKeysData.forEach(noteName => {
    const el = document.createElement('div');
    el.className = 'white-key';
    el.dataset.note = noteName;
    el.addEventListener('click', () => renderSingle(noteName)); // 【変更点】引数をシンプルに

    const baseNote = noteName.replace(/[0-9]/, '');
    const doremiText = noteToDoremi[baseNote];
    if (doremiText) {
      const label = document.createElement('div');
      label.className = 'key-label';
      label.textContent = doremiText;
      el.appendChild(label);
    }
    
    pianoRoot.appendChild(el);
    whiteKeyElements[noteName] = el;
  });

  blackKeysData.forEach(noteName => {
    const parentWhiteKeyName = noteName.replace('#', '');
    const parentElement = whiteKeyElements[parentWhiteKeyName] || whiteKeyElements[parentWhiteKeyName.slice(0, -1)];
    if (parentElement) {
      const blackKeyElement = document.createElement('div');
      blackKeyElement.className = 'black-key';
      blackKeyElement.dataset.note = noteName;
      const whiteKeyWidth = 36;
      const blackKeyWidth = 26;
      blackKeyElement.style.left = `${parentElement.offsetLeft + whiteKeyWidth - (blackKeyWidth / 2)}px`;
      blackKeyElement.addEventListener('click', e => { // 【変更点】引数をシンプルに
        e.stopPropagation();
        renderSingle(noteName);
      });
      pianoRoot.appendChild(blackKeyElement);
    }
  });
})();

/* ========= タブ切替 ========= */
Object.entries(tabs).forEach(([n, o]) => o.btn.addEventListener('click', () => switchTab(n)));
function switchTab(active) {
  Object.entries(tabs).forEach(([n, {btn, page}]) => {
    const on = n === active;
    btn.classList.toggle('active', on);
    page.classList.toggle('active', on);
  });
  currentSequenceIndex = null;
  currentNoteIndex = null;
  highlightKeys(null);
  
  // 【変更点】タブ切替時に表示をリセット
  keyFingeringDisplay.innerHTML = '<span>鍵盤を選択してください</span>';
  if (active === 'key') { 
      setStaff(null);
  }
}

/* ========= 矢印キー ナビ ========= */
document.addEventListener('keydown', e => {
  const isLeft = e.key === 'ArrowLeft';
  const isRight = e.key === 'ArrowRight';
  if (!isLeft && !isRight) return;
  e.preventDefault();
  if (tabs.key.page.classList.contains('active')) {
    moveNote(isLeft ? -1 : 1);
  } else if (tabs.seq.page.classList.contains('active')) {
    if (currentSequenceIndex === null || originalSequence.length === 0) return;
    const newIndex = currentSequenceIndex + (isLeft ? -1 : 1);
    if (newIndex >= 0 && newIndex < originalSequence.length) selectSequenceNote(newIndex);
  }
});

/* ========= Sequence Mode ========= */
const seqInput = document.getElementById('seq-input');
const seqBtn = document.getElementById('seq-btn');
const boardSeq = document.getElementById('board-seq');
const transposeControls = document.getElementById('transpose-controls');
const transposeLevel = document.getElementById('transpose-level');
const transposeUp = document.getElementById('transpose-up');
const transposeDown = document.getElementById('transpose-down');

const ESCAPED_KEYS = Object.keys(INPUT_TO_NOTE).sort((a,b) => b.length - a.length).map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
let originalSequence = [];
let transposition = 0;

function transposeNote(note, step) {
  if (note === 'REST') return 'REST';
  const idx = NOTE_TO_INDEX[note];
  if (idx === undefined) return null;
  const newIdx = idx + step;
  if (newIdx < 0 || newIdx >= OCARINA_RANGE.length) return null;
  return OCARINA_RANGE[newIdx];
}
function selectSequenceNote(index) {
  if (index < 0 || index >= originalSequence.length) return;
  currentSequenceIndex = index;
  const cards = boardSeq.querySelectorAll('.card');
  cards.forEach((c, i) => c.classList.toggle('active', i === index));
  const item = originalSequence[index];
  if (item.note === 'REST') { setStaff(null); highlightKeys(null); return; }
  
  const totalShift = transposition;
  const tNote = transposeNote(item.note, totalShift);
  if (tNote) {
    const staffKey = SHARP_TO_FLAT[tNote] || tNote;
    setStaff(staffKey);
    playNote(NOTE_FREQUENCIES[tNote]);
    highlightKeys(tNote);
  } else { setStaff(null); highlightKeys(null); }
}

function renderTransposedSequence() {
  boardSeq.innerHTML = '';
  highlightKeys(null);
  if (originalSequence.length === 0) { transposeControls.style.display = 'none'; setStaff(null); return; }
  transposeControls.style.display = 'flex';
  transposeLevel.textContent = `Key: ${transposition > 0 ? '+' : ''}${transposition}`;
  
  const totalShift = transposition;
  originalSequence.forEach((item, index) => {
    let card;
    if (item.note === 'REST') {
      card = createCard('REST', '休');
    } else {
      const tNote = transposeNote(item.note, totalShift);
      if (tNote) {
        const disp = (SHARP_TO_FLAT[tNote] || tNote).replace(/b/, '♭').replace(/#/, '♯');
        const lbl = item.lyric ? `${disp}（${item.lyric}）` : disp;
        card = createCard(tNote, lbl);
      } else {
        const lbl = item.lyric ? `音域外（${item.lyric}）` : '音域外';
        card = createCard(null, lbl);
      }
    }
    card.style.cursor = 'pointer';
    card.addEventListener('click', () => selectSequenceNote(index));

    card.addEventListener('contextmenu', e => {
      e.preventDefault();
      const currentItem = originalSequence[index];
      if (currentItem.note === 'REST') return;

      const currentNote = currentItem.note;
      let newNote;

      if (currentNote.endsWith('2')) {
        newNote = currentNote.slice(0, -1);
      } else {
        newNote = currentNote + '2';
      }
      
      if (NOTE_TO_INDEX.hasOwnProperty(newNote)) {
        originalSequence[index].note = newNote;
        renderTransposedSequence();
      }
    });

    boardSeq.appendChild(card);
  });
  if (currentSequenceIndex !== null && currentSequenceIndex < originalSequence.length) {
    selectSequenceNote(currentSequenceIndex);
  } else {
    const firstValid = originalSequence.findIndex(item => transposeNote(item.note, totalShift) !== null && item.note !== 'REST');
    if (firstValid !== -1) selectSequenceNote(firstValid); else setStaff(null);
  }
}

seqBtn.addEventListener('click', () => {
  const raw = seqInput.value;
  if (!raw.trim()) { originalSequence = []; currentSequenceIndex = null; renderTransposedSequence(); seqInput.focus(); return; }
  const tokenRegex = new RegExp(`(${ESCAPED_KEYS.join('|')})(?:（([^）]+)）)?|([ 　]+)`, 'gi');
  const matches = [...raw.matchAll(tokenRegex)];
  if (matches.length === 0) {
    boardSeq.innerHTML = '<p style="grid-column:1/-1;color:var(--text-light-color);">認識できる音名がありませんでした。</p>';
    originalSequence = []; currentSequenceIndex = null; renderTransposedSequence(); setStaff(null); return;
  }
  originalSequence = matches.map(m => {
    const noteToken = m[1];
    const lyricToken = m[2];
    const spaceToken = m[3];
    if (spaceToken) return { note: 'REST', lyric: '' };
    if (noteToken) {
      const token = noteToken.toUpperCase();
      const noteName = token.replace('♭','b').replace('♯','#');
      const lyric = lyricToken || '';
      const note = INPUT_TO_NOTE[noteName] || INPUT_TO_NOTE[m[1]];
      return { note, lyric };
    }
    return null;
  }).filter(Boolean);
  transposition = 0;  
  currentSequenceIndex = null;
  renderTransposedSequence();
});

transposeUp.addEventListener('click', () => { transposition++; renderTransposedSequence(); });
transposeDown.addEventListener('click', () => { transposition--; renderTransposedSequence(); });
seqInput.addEventListener('keydown', e => { if (e.key === 'Enter') seqBtn.click(); });
</script>
</body>
</html>